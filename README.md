# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Тен Денис`

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Задание 1. Решение Резервное копирование

Для повышения надежности работы баз данных и их резервного копирования, финансовая компания может использовать следующие варианты резервного копирования в различных сценариях:

1.1. Восстановление данных в полном объеме за предыдущий день:
   - Полные резервные копии: Регулярное создание полных копий баз данных ежедневно. Это позволит восстановить все данные за предыдущий день в случае потери или повреждения основной базы данных. Полные копии могут быть хранены на отдельных серверах или в облачном хранилище.
   - Журналы транзакций: Журналы транзакций записывают все изменения данных, которые произошли после последней полной резервной копии. При восстановлении данных необходимо применить последнюю полную копию и последующие журналы транзакций до нужного момента времени, чтобы восстановить данные за предыдущий день.

1.2. Восстановление данных за час до предполагаемой поломки:
   - Транзакционные журналы с точкой восстановления: Система должна регулярно создавать точки восстановления, которые сохраняют состояние базы данных в определенные моменты времени. При восстановлении данных можно использовать последнюю точку восстановления, ближайшую к моменту предполагаемой поломки, и применить последующие журналы транзакций до нужного момента времени.

1.3. Моментальное переключение на работающую или починенную базу данных:
   - Репликация баз данных: Создание реплик баз данных, которые являются копиями основной базы данных и постоянно синхронизируются с ней. В случае поломки основной базы данных, можно моментально переключиться на работающую реплику. Репликация может быть синхронной или асинхронной, в зависимости от требований к надежности и доступности данных.

Каждый из этих вариантов резервного копирования имеет свои преимущества и недостатки, и выбор оптимального варианта зависит от конкретных требований финансовой компании по надежности, восстановлению данных и доступности системы. Необходимо провести анализ требований и возможностей компании, чтобы определить наиболее подходящий вариант резервного копирования для каждого из сценариев.


---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Задание 2. Решение PostgreSQL

Пример команды резервирования данных (pg_dump):
```psql
pg_dump -U <username> -d <database_name> -f <backup_file.sql>
```
где:
- `<username>` - имя пользователя базы данных
- `<database_name>` - имя базы данных
- `<backup_file.sql>` - имя файла, в который будет сохранен резервный дамп данных

Пример команды восстановления БД (pg_restore):
```
pg_restore -U <username> -d <database_name> <backup_file.sql>
```
где:
- `<username>` - имя пользователя базы данных
- `<database_name>` - имя базы данных
- `<backup_file.sql>` - имя файла, из которого будет восстановлена база данных

Автоматизация процесса резервирования и восстановления БД возможна. Для этого можно использовать сценарии (скрипты) на языке программирования, которые будут выполнять соответствующие команды pg_dump и pg_restore. Например, на языке Python можно использовать библиотеку subprocess для выполнения команд в терминале. Также можно использовать планировщик задач (например, cron в Linux) для автоматического запуска скриптов резервирования и восстановления БД по заданному расписанию.

Также существуют готовые инструменты для автоматизации резервирования и восстановления БД PostgreSQL, например, pgBackRest, Barman, и другие. Эти инструменты предоставляют расширенные возможности, такие как инкрементное резервирование, управление хранилищем резервных копий, криптографическую защиту и т.д.


---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение Задание 3. MySQL

Команда инкрементного резервного копирования базы данных MySQL версия 8.4 https://dev.mysql.com/doc/refman/8.4/en/mysqldump.html

```sh
mysqldump --user=<username> --password=<password> --single-transaction --master-data=2 --order-by-primary --flush-logs --hex-blob --databases <database_name> > backup.sql
```

В этой команде используются следующие параметры:
- --user=<username>: указывает имя пользователя для подключения к базе данных.
- --password=<password>: указывает пароль для подключения к базе данных.
- --single-transaction: выполняет резервное копирование в рамках одной транзакции, чтобы не блокировать запись данных.
- --master-data=2: добавляет информацию о бинарных журналах и позиции репликации в файл резервной копии.
- --order-by-primary: упорядочивает данные по первичному ключу для обеспечения последовательности записей при восстановлении.
- --flush-logs: сбрасывает бинарные журналы после выполнения резервного копирования.
- --hex-blob: кодирует двоичные данные в шестнадцатеричном формате. Использование формата шестнадцатеричного блоба имеет несколько преимуществ. Он делает резервную копию базы данных более читабельной и удобной для отладки. Кроме того, это позволяет сохранить данные в формате, который можно легко импортировать и восстановить в другую базу данных MySQL или в другую среду.
- --databases <database_name>: указывает имя базы данных, которую нужно скопировать.
- > backup.sql: перенаправляет вывод команды в файл backup.sql.

Использование реплики базы данных может быть выгодным по сравнению с обычным резервным копированием в следующих случаях:

1. Уменьшение нагрузки на основную базу данных: При использовании реплики можно выполнять запросы на чтение с реплики, распределяя нагрузку между основной базой данных и репликой. Это особенно полезно при работе с высоконагруженными приложениями, где запросы на чтение составляют большую часть нагрузки.

2. Обеспечение отказоустойчивости: Реплика базы данных может служить резервным источником данных в случае отказа основной базы данных. Если основная база данных неожиданно выходит из строя, реплика может быть использована для продолжения работы системы без простоя.

3. Облегчение обновлений и тестирования: Реплика базы данных может использоваться для выполнения обновлений и тестирования новых функций без воздействия на основную базу данных. Это позволяет избежать потенциальных проблем, связанных с обновлениями в живой среде.

4. Шкалируемость: Репликация базы данных позволяет горизонтально масштабировать систему путем добавления дополнительных реплик для распределения нагрузки. Это особенно полезно при работе с большими объемами данных и высокими требованиями к производительности.

Все эти преимущества делают использование реплики базы данных MySQL более гибким и эффективным по сравнению с обычным резервным копированием во многих сценариях.
